name: TruffleHog Secret Scanning

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    - cron: '0 14 * * 6'  # Run weekly on Saturdays at 2 PM UTC
  workflow_dispatch:

jobs:
  trufflehog-scan:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
      
      - name: Run TruffleHog Secret Scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --debug
      
      - name: Install TruffleHog for Additional Scans
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Scan Git History
        run: |
          trufflehog git file://. \
            --json \
            --no-update \
            > trufflehog-git-report.json || true
      
      - name: Scan Filesystem
        run: |
          trufflehog filesystem . \
            --json \
            --no-update \
            > trufflehog-filesystem-report.json || true
      
      - name: Generate HTML Report
        if: always()
        run: |
          cat > trufflehog-report.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>TruffleHog Secret Scan Report - SkyLearn</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                  h1 { color: #c0392b; }
                  .secret { 
                      border: 2px solid #c0392b; 
                      padding: 15px; 
                      margin: 15px 0; 
                      background: white;
                      border-radius: 5px;
                  }
                  .file { color: #2c3e50; font-weight: bold; }
                  .detector { color: #e74c3c; }
                  .verified { color: #27ae60; }
                  .unverified { color: #f39c12; }
                  .summary { 
                      background: white; 
                      padding: 20px; 
                      border-radius: 5px; 
                      margin-bottom: 20px;
                      border-left: 5px solid #c0392b;
                  }
              </style>
          </head>
          <body>
              <h1>üîê TruffleHog Secret Scanning Report</h1>
              <div class="summary">
                  <h2>Scan Summary</h2>
                  <p><strong>Generated:</strong> $(date)</p>
                  <p><strong>Project:</strong> SkyLearn LMS</p>
                  <p><strong>Repository:</strong> Full git history + filesystem</p>
              </div>
          EOF
          
          for report in trufflehog-*-report.json; do
            if [ -f "$report" ]; then
              echo "<h2>Report: $report</h2>" >> trufflehog-report.html
              python3 -c "
          import json
          import html
          
          try:
              with open('$report', 'r') as f:
                  lines = f.readlines()
              
              count = 0
              for line in lines:
                  try:
                      data = json.loads(line.strip())
                      count += 1
                      
                      source = data.get('SourceMetadata', {})
                      file_name = source.get('Data', {}).get('Filesystem', {}).get('file', 
                                  source.get('Data', {}).get('Git', {}).get('file', 'Unknown'))
                      
                      detector = data.get('DetectorName', 'Unknown')
                      verified = data.get('Verified', False)
                      raw = data.get('Raw', '')[:100]  # First 100 chars
                      
                      status = 'verified' if verified else 'unverified'
                      status_text = '‚úÖ VERIFIED' if verified else '‚ö†Ô∏è UNVERIFIED'
                      
                      print(f'<div class=\"secret\">')
                      print(f'<h3>Finding #{count}</h3>')
                      print(f'<p class=\"file\">üìÑ File: {html.escape(str(file_name))}</p>')
                      print(f'<p class=\"detector\">üîç Detector: {html.escape(detector)}</p>')
                      print(f'<p class=\"{status}\">Status: {status_text}</p>')
                      print(f'<p><strong>Raw (truncated):</strong> <code>{html.escape(raw)}...</code></p>')
                      print('</div>')
                  except json.JSONDecodeError:
                      continue
              
              if count == 0:
                  print('<p style=\"color: green;\">‚úÖ No secrets detected in this scan!</p>')
              else:
                  print(f'<p style=\"color: red; font-weight: bold;\">‚ö†Ô∏è Total secrets found: {count}</p>')
          except Exception as e:
              print(f'<p>Error processing report: {html.escape(str(e))}</p>')
          " >> trufflehog-report.html
            fi
          done
          
          echo "</body></html>" >> trufflehog-report.html
      
      - name: Upload TruffleHog Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trufflehog-secret-reports
          path: |
            trufflehog-*-report.json
            trufflehog-report.html
          retention-days: 30
      
      - name: Generate Summary for PR
        if: always()
        run: |
          echo "## üîê TruffleHog Secret Scanning Results" > secret-summary.txt
          echo "" >> secret-summary.txt
          
          total_secrets=0
          verified_secrets=0
          
          for report in trufflehog-*-report.json; do
            if [ -f "$report" ]; then
              count=$(wc -l < "$report" || echo "0")
              total_secrets=$((total_secrets + count))
              
              verified=$(grep -c '"Verified":true' "$report" || echo "0")
              verified_secrets=$((verified_secrets + verified))
            fi
          done
          
          echo "### Summary" >> secret-summary.txt
          echo "- **Total Secrets Found:** $total_secrets" >> secret-summary.txt
          echo "- **Verified Secrets:** $verified_secrets" >> secret-summary.txt
          echo "- **Unverified Secrets:** $((total_secrets - verified_secrets))" >> secret-summary.txt
          echo "" >> secret-summary.txt
          
          if [ $verified_secrets -gt 0 ]; then
            echo "‚ö†Ô∏è **CRITICAL**: Verified secrets detected! Immediate action required." >> secret-summary.txt
          elif [ $total_secrets -gt 0 ]; then
            echo "‚ö†Ô∏è **WARNING**: Potential secrets detected. Review recommended." >> secret-summary.txt
          else
            echo "‚úÖ **CLEAR**: No secrets detected." >> secret-summary.txt
          fi
          
          echo "" >> secret-summary.txt
          echo "üìä Check artifacts for detailed reports." >> secret-summary.txt
      
      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const summary = fs.readFileSync('secret-summary.txt', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            } catch (error) {
              console.log('Summary file not found');
            }
      
      - name: Fail if Verified Secrets Found
        if: always()
        run: |
          verified_count=0
          for report in trufflehog-*-report.json; do
            if [ -f "$report" ]; then
              count=$(grep -c '"Verified":true' "$report" || echo "0")
              verified_count=$((verified_count + count))
            fi
          done
          
          if [ $verified_count -gt 0 ]; then
            echo "‚ùå FAILURE: $verified_count verified secret(s) found!"
            echo "Please remove the secrets and rotate credentials immediately."
            exit 1
          fi
